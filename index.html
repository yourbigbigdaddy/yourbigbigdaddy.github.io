<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Model Painting Custom Shop模型涂装定制店</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:0; background:#f7f7f8; color:#222; }
    header { background:#fff; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 0 rgba(0,0,0,.06); position:sticky; top:0; z-index:10; }
    .brand { font-weight:700; font-size:18px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .btn { background:#111; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111; border:1px solid #ddd; }
    main { padding:20px; max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 320px; gap:20px; }
    .products { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; }
    .card { background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(20,20,30,.04); display:flex; flex-direction:column; gap:8px; }
    .card img { width:100%; height:150px; object-fit:cover; border-radius:6px; }
    .price { font-weight:700; }
    .cart { background:#fff; padding:10px; border-radius:8px; box-shadow:0 6px 18px rgba(20,20,30,.04); }
    .cart h3 { margin:0 0 8px 0; }
    .cartlist { max-height:360px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .cartitem { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .small { font-size:13px; color:#666; }
    .coupon { margin-top:8px; display:flex; gap:6px; }
    #paypal-buttons { margin-top:12px; }
    footer { padding:20px; text-align:center; color:#888; font-size:13px; }
    .langbtn { border:1px solid #eee; padding:6px 8px; border-radius:6px; cursor:pointer; background:#fff; }
    /* 轮播弹窗相关 */
    #quick-view-modal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9999; background:rgba(0,0,0,0.65); align-items:center; justify-content:center; }
    #quick-view-modal .quick-modal-content { background:#fff; padding:24px; border-radius:10px; max-width:90vw; max-height:90vh; position:relative; display:flex; flex-direction:column; align-items:center; }
    /* 显示大图：最大宽度1000px，最大高度80vh，宽高自适应窗口 */
    #quick-view-modal img { width:auto; height:auto; max-width:1000px; max-height:80vh; border-radius:8px; margin-bottom:12px; background:#eee; display:block; }
    #quick-view-modal .quick-close-btn { position:absolute;right:10px;top:10px;font-size:22px;background:transparent;border:none;cursor:pointer; }
    @media (max-width:900px){
      main { grid-template-columns:1fr; }
      .cart{ order:2 }
      #quick-view-modal img { max-width:98vw; max-height:65vh; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" id="site-title">Model Painting Custom Shop</div>
    <div class="controls">
      <div>
        <button class="langbtn" onclick="setLang('zh')">中文</button>
        <button class="langbtn" onclick="setLang('en')">EN</button>
      </div>
      <div style="width:12px"></div>
      <div id="cart-toggle" class="btn" onclick="toggleCart()">购物车 (<span id="cart-count">0</span>)</div>
    </div>
  </header>

  <main>
    <section>
      <h2 id="heading-products">产品</h2>
      <div class="products" id="products"></div>
    </section>

    <aside class="cart" id="cart-panel" style="display:block;">
      <h3 id="cart-title">购物车</h3>
      <div class="cartlist" id="cart-list"></div>
      <div class="small" id="cart-subtotal">小计: $0.00</div>

      <div class="coupon">
        <input id="coupon-code" placeholder="优惠码 (例: DISCOUNT10)" style="flex:1; padding:8px; border:1px solid #eee; border-radius:6px;" />
        <button class="btn secondary" onclick="applyCoupon()">使用</button>
      </div>
      <div class="small" id="coupon-msg"></div>

      <div id="paypal-buttons"></div>
    </aside>
  </main>

  <footer>© 模型涂装定制店Model Painting Custom Shop</footer>

  <!-- 轮播弹窗结构 -->
  <div id="quick-view-modal">
    <div class="quick-modal-content">
      <button class="quick-close-btn" id="quick-close-btn">×</button>
      <img id="quick-img" src="" />
      <div style="display:flex;gap:16px;align-items:center;justify-content:center;">
        <button id="quick-prev" class="btn secondary">上一张</button>
        <span id="quick-index" class="small">1/5</span>
        <button id="quick-next" class="btn secondary">下一张</button>
      </div>
    </div>
  </div>

  <!-- PayPal SDK：把 client-id 换成你自己的（sandbox 或 live） -->
  <script src="https://www.paypal.com/sdk/js?client-id=AVIwqSMaljVYyZ6Lx3FRqdavhLPGNBoq5-CydnhCespvJoeaYtBXnypAN8qoVGfrWRkARWULH2_7Anrd&currency=USD"></script>

  <script>
    /********** 基础数据（把产品改成你自己的） **********/
    const PRODUCTS = [
      {
        id: "mug001",
        title: { zh: "举刀的小人", en: "Man with a Knife" },
        price: 18.00,
        currency: "USD",
        stock: 20,
        img: "image/微信图片_20250917183827_3103_215.jpg",
        description: { zh: "精涂黄色小人", en: "Carefully painted yellow little monster" }
      },
      {
        id: "shirt001",
        title: { zh: "蓝色小人", en: "A blue soldier" },
        price: 13.00,
        currency: "USD",
        stock: 10,
        img: "image/微信图片_20250917183828_3104_215.jpg",
        description: { zh: "我也不知道叫啥名", en: "IDK his name" }
      }
    ];

    // 快速浏览图片数组，每个商品5张
    const QUICK_VIEW_IMAGES = {
      "mug001": [
        "image/1.jpg",
        "image/2.jpg",
        "image/3.jpg",
        "image/4.jpg",
        "image/5.jpg"
      ],
      "shirt001": [
        "image/11.jpg",
        "image/22.jpg",
        "image/33.jpg",
        "image/44.jpg",
        "image/55.jpg"
      ]
    };
    let quickIndex = 0;
    let quickViewImages = [];

    // 简易优惠券（客户端验证：仅作示例）
    const COUPONS = {
      "DISCOUNT10": { type: "percent", value: 10 }, // 10% off
      "SAVE5": { type: "fixed", value: 5 } // $5 off
    };

    /********** 状态 **********/
    let lang = localStorage.getItem('lang') || 'zh';
    let cart = JSON.parse(localStorage.getItem('cart_v1') || "[]");
    let appliedCoupon = null;

    /********** 渲染 产品 列表 **********/
    function formatMoney(n){ return Number(n).toFixed(2); }

    function renderProducts(){
      const cont = document.getElementById('products');
      cont.innerHTML = '';
      PRODUCTS.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${p.img}" alt="${p.title[lang]}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">${p.title[lang]}</div>
              <div class="small">${p.description[lang]}</div>
            </div>
            <div style="text-align:right">
              <div class="price">$${formatMoney(p.price)}</div>
              <div class="small">Stock: ${p.stock}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="addToCart('${p.id}', 1)">${lang==='zh'?'加入购物车':'Add'}</button>
            <button class="btn secondary" onclick="openQuick('${p.id}')">${lang==='zh'?'快速预览':'Quick view'}</button>
          </div>
        `;
        cont.appendChild(card);
      });
    }

    /********** 快速浏览轮播相关 **********/
    function showQuickView(images, startIdx = 0){
      quickViewImages = images;
      quickIndex = startIdx;
      const modal = document.getElementById('quick-view-modal');
      const img = document.getElementById('quick-img');
      const idxText = document.getElementById('quick-index');
      function update(){
        img.src = quickViewImages[quickIndex];
        idxText.innerText = (quickIndex+1) + "/" + quickViewImages.length;
      }
      update();
      modal.style.display = 'flex';

      // 按钮事件
      document.getElementById('quick-prev').onclick = function(){
        quickIndex = (quickIndex - 1 + quickViewImages.length) % quickViewImages.length;
        update();
      };
      document.getElementById('quick-next').onclick = function(){
        quickIndex = (quickIndex + 1) % quickViewImages.length;
        update();
      };
      document.getElementById('quick-close-btn').onclick = function(){
        modal.style.display = 'none';
      };
      // 点击遮罩关闭
      modal.onclick = function(e){
        if(e.target === modal) modal.style.display = 'none';
      };
    }

    function openQuick(id){
      const images = QUICK_VIEW_IMAGES[id] || [];
      if (images.length === 0) {
        alert(lang === 'zh' ? '没有可预览图片' : 'No images for this product');
        return;
      }
      showQuickView(images, 0); // 默认从第一张图开始
    }

    /********** 购物车逻辑 **********/
    function saveCart(){ localStorage.setItem('cart_v1', JSON.stringify(cart)); renderCartCount(); renderCart(); }

    function addToCart(id, qty=1){
      const p = PRODUCTS.find(x=>x.id===id);
      if(!p) return alert('Product not found');
      const item = cart.find(i=>i.id===id);
      const newQty = (item? item.qty : 0) + qty;
      if(newQty > p.stock) return alert(lang==='zh'?'库存不足':'Not enough stock');
      if(item) item.qty = newQty; else cart.push({ id: id, qty: qty, price: p.price, title: p.title });
      saveCart();
      alert(lang==='zh'?'已加入购物车':'Added to cart');
    }

    function removeFromCart(id){
      cart = cart.filter(i=>i.id!==id);
      saveCart();
    }

    function changeQty(id, qty){
      const p = PRODUCTS.find(x=>x.id===id);
      if(qty < 1) return removeFromCart(id);
      if(qty > p.stock) return alert(lang==='zh'?'库存不足':'Not enough stock');
      const item = cart.find(i=>i.id===id);
      if(item) item.qty = qty;
      saveCart();
    }

    function computeSubtotal(){
      return cart.reduce((s,i)=> s + (i.price * i.qty), 0);
    }

    function renderCart(){
      const list = document.getElementById('cart-list');
      list.innerHTML = '';
      if(cart.length===0){
        list.innerHTML = `<div class="small">${lang==='zh'?'购物车为空':'Your cart is empty'}</div>`;
      } else {
        cart.forEach(i=>{
          const p = PRODUCTS.find(x=>x.id===i.id);
          const div = document.createElement('div');
          div.className = 'cartitem';
          div.innerHTML = `
            <div style="flex:1">
              <div style="font-weight:600">${ (i.title && i.title[lang]) ? i.title[lang] : (p? p.title[lang] : i.id) }</div>
              <div class="small">$${formatMoney(i.price)} × 
                <input style="width:48px;padding:4px;margin-left:6px" type="number" min="1" value="${i.qty}" onchange="changeQty('${i.id}', Number(this.value))" />
              </div>
            </div>
            <div style="text-align:right">
              <div class="small">$${formatMoney(i.price * i.qty)}</div>
              <div><button class="btn secondary" onclick="removeFromCart('${i.id}')">${lang==='zh'?'移除':'Remove'}</button></div>
            </div>
          `;
          list.appendChild(div);
        });
      }
      const subtotal = computeSubtotal();
      let total = subtotal;
      if(appliedCoupon){
        if(appliedCoupon.type === 'percent') total = total * (1 - appliedCoupon.value/100);
        else if(appliedCoupon.type === 'fixed') total = Math.max(0, total - appliedCoupon.value);
      }
      document.getElementById('cart-subtotal').innerText = (lang==='zh'?'小计':'Subtotal') + `: $${formatMoney(total)}`;
      document.getElementById('coupon-msg').innerText = appliedCoupon ? (lang==='zh'?'已应用优惠码':'Coupon applied') : '';
      renderPayPalButtons(); // 每次渲染时更新按钮（PayPal 按钮会被销毁重建）
      renderCartCount();
    }

    function renderCartCount(){
      const count = cart.reduce((s,i)=> s + i.qty, 0);
      document.getElementById('cart-count').innerText = count;
    }

    function toggleCart(){
      const panel = document.getElementById('cart-panel');
      panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    }

    function applyCoupon(){
      const code = document.getElementById('coupon-code').value.trim().toUpperCase();
      if(!code) return alert(lang==='zh'?'请输入优惠码':'Please enter coupon code');
      const c = COUPONS[code];
      if(!c) return alert(lang==='zh'?'优惠码无效':'Coupon invalid');
      appliedCoupon = c;
      saveCart();
      alert(lang==='zh'?'已应用优惠':'Coupon applied');
    }

    /********** 多语言 **********/
    function setLang(l){
      lang = l;
      localStorage.setItem('lang', lang);
      document.getElementById('site-title').innerText = (lang==='zh'?'模型涂装定制店':'Model Painting Custom Shop');
      document.getElementById('heading-products').innerText = (lang==='zh'?'成品':'Finished Products');
      document.getElementById('cart-title').innerText = (lang==='zh'?'购物车':'Cart');
      renderProducts();
      renderCart();
    }

    /********** PayPal 客户端结账（actions.order.create） **********/
    function renderPayPalButtons(){
      const container = document.getElementById('paypal-buttons');
      container.innerHTML = '';
      if(cart.length === 0) return;
      if(typeof paypal === 'undefined'){ container.innerText = (lang==='zh'?'支付暂不可用':'Payment unavailable'); return; }

      paypal.Buttons({
        createOrder: function(data, actions) {
          const subtotal = computeSubtotal();
          let total = subtotal;
          if(appliedCoupon){
            if(appliedCoupon.type === 'percent') total = total * (1 - appliedCoupon.value/100);
            else if(appliedCoupon.type === 'fixed') total = Math.max(0, total - appliedCoupon.value);
          }
          const items = cart.map(i=>{
            const p = PRODUCTS.find(x=>x.id===i.id);
            return {
              name: (p ? p.title.en : i.id),
              unit_amount: { currency_code: "USD", value: formatMoney(i.price) },
              quantity: String(i.qty)
            };
          });

          return actions.order.create({
            purchase_units: [{
              amount: {
                currency_code: "USD",
                value: formatMoney(total),
                breakdown: {
                  item_total: { currency_code: "USD", value: formatMoney(total) }
                }
              },
              items: items
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            const payerName = details.payer && details.payer.name && details.payer.name.given_name ? details.payer.name.given_name : '';
            alert((lang==='zh'?'支付成功，感谢 ':'Payment complete, thanks ') + payerName + '!');
            cart = [];
            appliedCoupon = null;
            saveCart();
          });
        },
        onError: function(err){
          console.error(err);
          alert(lang==='zh'?'支付遇到错误':'Payment error occurred');
        }
      }).render('#paypal-buttons');
    }

    /********** 启动渲染 **********/
    (function init(){
      setLang(lang);
      renderProducts();
      renderCart();
    })();
  </script>
</body>
</html>